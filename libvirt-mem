#!/usr/bin/env bash
u(){ echo "usage: $0 [<URI>]">&2;exit 1;};(($#-1))||c="$1"&&{ !(($#-2))&&u;};p='RAM';c="${c:-""}";g(){ grep "${@}";};e(){ echo "${@}";};y="maximum";l(){ for x in 2 2 1;do for _ in $(seq 15);do e -n '-';done;((--x))&&e -n '|';done;[[ "$1" ]] && echo -e '\n';};k="KiB";v(){ virsh -c "$c" "${@}";};s(){ { t=1;s=$((t-1));r=$((t-s));q='name';while read m v z;do ((t))&&e -e "$q|$y $p|current $p"&&{ l 1;t=0;};printf '%s:|%10d%s |%10d%s\n' $v $m $k $z $k;s=$((m+s));r=$((z+r));done;l;printf '\ntotal:|%10d%s |%10d%s' $s $k $r $k ;}|column -ts'|' -o '| ';};for h in $(v list --name);do o="$(v dumpxml $h|g -e currentMemory -e memory)";i=$(e "$o" | head -1 | g -oP '\d+');e "$o" | head -2 | tail -1 | g -oP '\d+'|cat <(e $i) <(e $h) - |tr '\n' ' '|cat - <(e -e '\n');done|sort -u|comm -23 - <(e -e '\n')|s
